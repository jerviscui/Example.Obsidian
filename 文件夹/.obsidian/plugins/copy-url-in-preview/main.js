/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var E=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var F=Object.prototype.hasOwnProperty;var x=(a,o)=>{for(var e in o)E(a,e,{get:o[e],enumerable:!0})},S=(a,o,e,n)=>{if(o&&typeof o=="object"||typeof o=="function")for(let t of C(o))!F.call(a,t)&&t!==e&&E(a,t,{get:()=>o[t],enumerable:!(n=L(o,t))||n.enumerable});return a};var U=a=>S(E({},"__esModule",{value:!0}),a);var N={};x(N,{default:()=>w});module.exports=U(N);var r=require("obsidian");var A=5e3;function R(a,o){let e=new Promise((n,t)=>{let s=setTimeout(()=>{clearTimeout(s),t(`timed out after ${a} ms`)},a)});return Promise.race([o,e])}async function g(a){return R(A,(()=>new Promise((e,n)=>{let t=new Image;t.crossOrigin="anonymous",t.onload=()=>{let s=document.createElement("canvas");s.width=t.width,s.height=t.height,s.getContext("2d").drawImage(t,0,0),s.toBlob(c=>{e(c)})},t.onerror=async()=>{try{await fetch(t.src,{mode:"no-cors"});let s=await g(`https://api.allorigins.win/raw?url=${encodeURIComponent(a)}`);e(s)}catch(s){n()}},t.src=a}))())}function d(a,o,e,n,t){return a.on(o,e,n,t),()=>a.off(o,e,n,t)}function I(a){let o=a.target;if(!(o instanceof HTMLImageElement))console.error("imageElement is supposed to be a HTMLImageElement. imageElement:"),console.error(o);else return o}function b(a,o){let n=o.vault.adapter.getFilePath("").replace("file://",""),t=a.pathname;if(t.startsWith(n)){let s=t.substring(n.length+1);return decodeURI(s)}}function P(a,o){let e=I(a);if(!e)return;let n=o.workspace.getLeaf(!0);o.workspace.setActiveLeaf(n,{focus:!0});let t=b(new URL(e.currentSrc),o);if(t){let p=n.view.titleContainerEl;p.empty(),p.createEl("div",{text:t})}let s=n.view.contentEl;s.empty();let c=s.createEl("div",{}).appendChild(document.createElement("img"));c.src=e.currentSrc}var u=require("obsidian"),M={pdfMenu:!1,middleClickNewTab:!0},h=class extends u.PluginSettingTab{constructor(e,n){super(e,n);this.plugin=n}display(){let{containerEl:e}=this;e.empty(),e.createEl("h3",{text:"Image Context Menus settings"}),new u.Setting(e).setName("PDF context menu").addToggle(n=>{n.setValue(this.plugin.settings.pdfMenu).onChange(t=>{this.plugin.settings.pdfMenu=t,this.plugin.saveSettings()})}),new u.Setting(e).setName("Middle mouse click on image link to open in new tab").addToggle(n=>{n.setValue(this.plugin.settings.middleClickNewTab).onChange(t=>{this.plugin.settings.middleClickNewTab=t,this.plugin.saveSettings()})})}};var _="/_capacitor_file_",D=1800,B=500,W=6e4,f=100,y=5e3,w=class extends r.Plugin{async loadSettings(){this.settings=Object.assign({},M,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async onload(){await this.loadSettings(),this.addSettingTab(new h(this.app,this)),this.registerDocument(document),this.app.workspace.on("window-open",(e,n)=>{this.registerDocument(n.document)})}registerDocument(e){this.register(d(e,"mouseover",".pdf-embed iframe, .pdf-embed div.pdf-container, .workspace-leaf-content[data-type=pdf]",this.showOpenPdfMenu.bind(this))),this.register(d(e,"mousemove",".pdf-canvas",this.showOpenPdfMenu.bind(this))),r.Platform.isDesktop?(this.register(d(e,"contextmenu","img",this.onImageContextMenu.bind(this))),this.register(d(e,"mouseup","img",this.onImageMouseUp.bind(this))),this.register(d(e,"mouseover",".cm-link, .cm-hmd-internal-link",this.storeLastHoveredLinkInEditor.bind(this))),this.register(d(e,"mouseover","a.internal-link",this.storeLastHoveredLinkInPreview.bind(this)))):(this.register(d(e,"touchstart","img",this.startWaitingForLongTap.bind(this))),this.register(d(e,"touchend","img",this.stopWaitingForLongTap.bind(this))),this.register(d(e,"touchmove","img",this.stopWaitingForLongTap.bind(this))))}storeLastHoveredLinkInEditor(e){var l;let n=(l=this.app.workspace.getActiveViewOfType(r.MarkdownView))==null?void 0:l.editor;if(!n)return;let t=n.posAtMouse(e),s=n.getClickableTokenAt(t);s&&(this.lastHoveredLinkTarget=s.text)}storeLastHoveredLinkInPreview(e,n){this.lastHoveredLinkTarget=n.getAttribute("data-href")}showOpenPdfMenu(e,n){var p;if(!this.settings.pdfMenu||this.openPdfMenu||this.preventReopenPdfMenu)return;let t=n.getBoundingClientRect();if(t.left+f<e.x&&e.x<t.right-f&&t.top+f<e.y&&e.y<t.bottom-f)return;let s=n.closest(".pdf-embed"),l;if(s){let i;s.hasClass("popover")?i=this.lastHoveredLinkTarget:i=(p=s.getAttr("src"))!=null?p:this.lastHoveredLinkTarget,i=i==null?void 0:i.replace(/#page=\d+$/,"");let m=this.app.workspace.getActiveFile().path;l=this.app.metadataCache.getFirstLinkpathDest(i,m)}else l=this.app.workspace.getActiveFile();let c=new r.Menu;this.registerEscapeButton(c),c.onHide(()=>this.openPdfMenu=void 0),c.addItem(i=>i.setIcon("pdf-file").setTitle("Open PDF externally").onClick(async()=>{this.preventReopenPdfMenu=!0,setTimeout(()=>{this.preventReopenPdfMenu=!1},y),this.hideOpenPdfMenu(),r.Platform.isDesktop?this.app.openWithDefaultApp(l.path):await this.app.vault.adapter.open(l.path)})),c.showAtMouseEvent(e),this.openPdfMenu=c,setTimeout(this.hideOpenPdfMenu.bind(this),y)}registerEscapeButton(e,n=activeDocument){e.register(d(n,"keydown","*",t=>{t.key==="Escape"&&(t.preventDefault(),t.stopPropagation(),e.hide())}))}hideOpenPdfMenu(){this.openPdfMenu&&this.openPdfMenu.hide()}startWaitingForLongTap(e,n){this.longTapTimeoutId?(clearTimeout(this.longTapTimeoutId),this.longTapTimeoutId=void 0):e.targetTouches.length==1&&(this.longTapTimeoutId=window.setTimeout(this.processLongTap.bind(this,e,n),B))}stopWaitingForLongTap(){this.longTapTimeoutId&&(clearTimeout(this.longTapTimeoutId),this.longTapTimeoutId=void 0)}async processLongTap(e,n){e.stopPropagation(),this.longTapTimeoutId=void 0;let t=this.app.vault.adapter,s=window,l=t.getFullPath(""),p=s.WEBVIEW_SERVER_URL+_+l;if(n.src.startsWith(p)){let i=n.src.replace(p,""),m=decodeURIComponent(i);await t.open(m)}else try{let i=await g(n.src);if(!i.type.startsWith("image/")){new r.Notice(`Unsupported mime type ${i.type}`);return}let m=i.type.replace("image/",""),v=`/.temp-${window.URL.createObjectURL(new Blob([])).split("/").pop()}.${m}`,k=await i.arrayBuffer();await t.writeBinary(v,k),setTimeout(()=>t.remove(v),W),new r.Notice("Image was temporarily saved and will be removed in 1 minute"),await t.open(v)}catch(i){new r.Notice("Cannot open image")}}onImageContextMenu(e){let n=I(e);if(!n)return;e.preventDefault();let t=new r.Menu,s=n.currentSrc,l=new URL(s),c=l.protocol;switch(c){case"app:":case"data:":case"http:":case"https:":if(t.addItem(p=>p.setIcon("image-file").setTitle("Copy image to clipboard").onClick(async()=>{try{let i=await g(s),m=new ClipboardItem({[i.type]:i});await navigator.clipboard.write([m]),new r.Notice("Image copied to the clipboard!",D)}catch(i){new r.Notice("Error, could not copy the image!")}})),c==="app:"&&r.Platform.isDesktop){let p=b(l,this.app);p&&(t.addItem(i=>i.setIcon("arrow-up-right").setTitle("Open in new tab").onClick(()=>{P(e,this.app)})),t.addItem(i=>i.setIcon("arrow-up-right").setTitle("Open in default app").onClick(()=>this.app.openWithDefaultApp(p))),t.addItem(i=>i.setIcon("arrow-up-right").setTitle(r.Platform.isMacOS?"Reveal in Finder":"Show in system explorer").onClick(()=>{this.app.showInFolder(p)})),t.addItem(i=>i.setIcon("folder").setTitle("Reveal file in navigation").onClick(()=>{var T;let m=this.app.vault.getFileByPath(p);if(!m){console.warn(`getFileByPath returned null for ${p}`);return}(T=this.app.internalPlugins.getEnabledPluginById("file-explorer"))==null||T.revealInFolder(m)})))}break;default:new r.Notice(`no handler for ${c} protocol`);return}this.registerEscapeButton(t),t.showAtPosition({x:e.pageX,y:e.pageY}),this.app.workspace.trigger("copy-url-in-preview:contextmenu",t)}onImageMouseUp(e){e.button==1&&this.settings.middleClickNewTab&&P(e,this.app)}};
